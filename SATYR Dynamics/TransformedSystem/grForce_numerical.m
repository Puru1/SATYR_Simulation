%%
clearvars -except K angle_of_linearization theta2_num_rad theta1_num theta2_num;
%Attempting the centroidal momentum matrix method
syms xW theta1 theta2 theta3 
syms dxW dtheta1 dtheta2 dtheta3
syms ddxW ddtheta1 ddtheta2 ddtheta3 tau1 tau2 tau3
syms theta_t zR
syms dtheta_t dzR

simTime = 6;
%Angle to linearize the following terms around
global valM valL theta1_num theta2_num K
valM = [.5 .1 .1 15];
valL = [.5 .5 .1];

use_joints = false;
theta1_num = pi/18;%angle of linearization
theta2_num = findTheta2(theta1_num, use_joints);
theta3_num = 0;
anlge_of_linearization = theta1_num;
theta2_num_rad = theta2_num;

%% Solving ODE for q and dq
g = 9.81;
mW = .5;
m_motor = .2;
mK = .2*m_motor;
mH = 2*m_motor;
mCM1 = .1;
mCM2 = .1;
mR = 15;
L1 = 0.5; 
L2 = 0.5;
L3 = .1;
R = 0.05;
IW = mW*R^2; %
IK = mK*R^2;
IH = mH*R^2;
IR = mR*(2*L3)^2/12;

%State Space
A_lin10 = [[ 0, -259.08413362169409832868831478607, -132.65400523114639256993446567455,  0.5502624275988558302947043437107, 0, 0, 0, 0]
          [ 0,  266.17052068708519049995078120441, -47.054203706155244301920425390059, 0.19518566601109104257978975042735, 0, 0, 0, 0]
          [ 0,  14.836788592379755072999675366041,  375.40784097920234401454886526972, -59.260867715674028173069898734423, 0, 0, 0, 0]
          [ 0, -286.83081601782227832660041669016, -335.15833436127143105535725294296,  348.57382324391434039238667599041, 0, 0, 0, 0]];
      
A = [[zeros(4,4) eye(4)]; A_lin10];

B_lin10 = [[  5.2182070599474844312044859433337, 0.096300253373682120313609150277507,  -1.8617155650572178960025564232675]
          [ -7.7353243571523886234420703536461,   4.9270588988703390737678777480557, -0.66037616646763612381258717490031]
          [  4.7344583921229748331406594475006,   -10.87881842211267043003611835042,   10.022470329151629670559325851689]
          [  3.0630549636467996681925256716347,   10.022470329151629670559325851689,  -33.306111245660668413011555958578]];
      
B_top = zeros(4,3);
B = [B_top; B_lin10];

Qq = diag([1000 1 10 1 10 10 1000 1000]);
Ru = diag([1 1 1]);
K = lqr(A,B,Qq,Ru);

%q0 = [0; theta1_num; 0; 0; 0; 0; 0; 0];
T_const_mat = [ 0, -0.00057580810416204919645947001653664, 1.0859968345774975487046339552572, 1.5707963267948966192313216916398, 0, 0, 0, 0]';
q0 = [0; theta1_num; 0; 0; 0; 0; 0; 0] - T_const_mat;
[T,X] = ode45(@SimpleSegway,[0 simTime],q0);

xW_array = X(:,1); 
theta1_array = X(:,2); 
theta2_array = X(:,3);
theta3_array = X(:,4);
dxW_array = X(:,5); 
dtheta1_array = X(:,6); 
dtheta2_array = X(:,7);
dtheta3_array = X(:,8);

limx = simTime;

figure(1);
plot(T,X(:,1:4));
title('Positions')
xlim([0 limx]);
xlabel('Time (sec)');
ylabel('Meters or Radians');
legend('xW', '\theta_{1}', '\theta_{2}', '\theta_{3}');

figure(2);
plot(T,X(:,5:8));
title('Velocity')
xlim([0 limx]);
xlabel('Time (sec)');
ylabel('Rads/sec');
name = legend('$\dot{xW}$', '$\dot{\theta_{1}}$', '$\dot{\theta_{2}}$', '$\dot{\theta_{3}}$');
set(name,'Interpreter','latex');

%%
%Recalculating accelerations within the system

ddX= zeros(length(xW_array),4);
ddzR_array = zeros(length(xW_array),1);
Fext_array = zeros(length(xW_array),1);
zR_array = zeros(length(xW_array),1);
cond_array = zeros(length(xW_array),1);

for j = 1:length(xW_array)
    
    %Single Instance Variables
    X_ref = [0 theta1_num theta2_num 0 0 0 0 0]';
    tau_ref_10 = [0, -12.9039, -2.1446]';
    xW = xW_array(j);
    theta1 = theta1_array(j);
    theta2 = theta2_array(j);
    theta3 = theta3_array(j);
    dxW = dxW_array(j);
    dtheta1 = dtheta1_array(j);
    dtheta2 = dtheta2_array(j);
    dtheta3 = dtheta3_array(j); 
    
    %Calculating ddq = (H^-1)*(u-C)
    H = [[                                                                                                                                                                                                                                                                                                                                                                                                        mCM1 + mCM2 + mR + mW + 13/(10000*R*conj(R)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (mCM2*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/2 + (mR*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (mCM2*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (mCM1*cos(conj(theta1))*conj(L1))/4 + (L1*mCM1*cos(theta1))/4,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 + (L2*mCM2*cos(theta1 + theta2))/4 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2))/4,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (L3*mR*cos(theta1 + theta2 + theta3))/2 + (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2]
         [ (mCM2*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/2 + (mR*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (mCM2*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (mCM1*cos(conj(theta1))*conj(L1))/4 + (L1*mCM1*cos(theta1))/4,                                                                                                                                                                                                                                                                                                                                                                                                                            mCM2*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)) + mR*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + mCM2*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)) + mR*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (L1*mCM1*cos(conj(theta1))*conj(L1)*cos(theta1))/4 + (L1*mCM1*sin(conj(theta1))*conj(L1)*sin(theta1))/4 + 13/250, (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 + (mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L2*mCM2*sin(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/4 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/4 + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/4 + (L2*mCM2*cos(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/4 + 51/1000, (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + 1/20]
         [                                                                                                                                                                         (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 + (L2*mCM2*cos(theta1 + theta2))/4 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2))/4, (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 + (mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L2*mCM2*sin(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/4 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/4 + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/4 + (L2*mCM2*cos(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/4 + 51/1000,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) + mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/4 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/4 + 51/1000,                                                                                             (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + 1/20]
         [                                                                                                                                                                                                                                                                                                                                           (L3*mR*cos(theta1 + theta2 + theta3))/2 + (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + 1/20,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + 1/20,                                                                                                                                                                                                                                                                                                                                                                                                                                                               L3*mR*cos(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + L3*mR*sin(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + 1/20]];

    C =[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - dtheta3*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta1))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta2))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta3))/2 + (L3*dtheta1*mR*sin(theta1 + theta2 + theta3))/2 + (L3*dtheta2*mR*sin(theta1 + theta2 + theta3))/2 + (L3*dtheta3*mR*sin(theta1 + theta2 + theta3))/2) - dtheta2*(dtheta1*((mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L2*mCM2*sin(theta1 + theta2))/4) + dtheta2*((mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L2*mCM2*sin(theta1 + theta2))/4) + (conj(dtheta1)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (conj(dtheta2)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta3))/2 + (L3*dtheta3*mR*sin(theta1 + theta2 + theta3))/2) - dtheta1*(dtheta1*((mR*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 + (mCM2*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/2 + (L1*mCM1*sin(theta1))/4) + dtheta2*((mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L2*mCM2*sin(theta1 + theta2))/4) + (conj(dtheta2)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (conj(dtheta1)*(mCM2*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2) + mR*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM1*sin(conj(theta1))*conj(L1))/2))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta3))/2 + (L3*dtheta3*mR*sin(theta1 + theta2 + theta3))/2)
                                                                                                                                                                                                                                                                                                                                                   dxW*((conj(dtheta2)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (conj(dtheta1)*(mCM2*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2) + mR*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM1*sin(conj(theta1))*conj(L1))/2))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta3))/2) - dtheta1*(dxW*((mCM2*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (mR*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mCM1*sin(conj(theta1))*conj(L1))/4) + (conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) + mCM2*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)) + (L1*mCM1*sin(theta1))/2))/2) - dtheta3*((conj(dtheta1)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))))/2 + dtheta3*((L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2 - (L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + (conj(dtheta2)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))))/2 + dtheta2*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2) + dtheta1*((L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2) + (conj(dtheta3)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) - L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2 + (dxW*mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + dtheta2*(dtheta1*((mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 - (mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 - (mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L2*mCM2*cos(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/4 - (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/4 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/4 - (L2*mCM2*sin(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/4) + (conj(dtheta3)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) + mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))))/2 - dxW*((mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/4) + dtheta2*((mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 - (mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L2*mCM2*cos(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/4 - (L2*mCM2*sin(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/4 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/8 - (L2*mCM2*sin(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/8) + (conj(dtheta1)*(mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) - mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) + mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) - mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + (L2*mCM2*cos(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 - (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/2 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/2 - (L2*mCM2*sin(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/2))/2 - (conj(dtheta2)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) + mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/2 - (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/2 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/4 - (L2*mCM2*sin(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/4))/2 - (conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2))/2 + dtheta3*((L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2)) + (dtheta1*conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) + mCM2*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)) + (L1*mCM1*sin(theta1))/2))/2 + (dtheta2*conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2))/2 - g*mR*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) - g*mCM2*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)) - (L1*g*mCM1*sin(theta1))/2 + (L3*dtheta3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2
     dxW*((conj(dtheta1)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (conj(dtheta2)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta3))/2) - dtheta1*((conj(dtheta3)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) + mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))))/2 + (conj(dtheta1)*(mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) - mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) + mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) - mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + (L2*mCM2*cos(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 - (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/2 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/2 - (L2*mCM2*sin(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/2))/2 - (conj(dtheta2)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) + mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/2 - (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/2 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/4 - (L2*mCM2*sin(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/4))/2 - (conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2))/2) - dtheta1*(dxW*((mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/4) + (conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2))/2) - dtheta2*(dxW*((mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/4) + dtheta1*((mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 + (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 - (mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/4 - (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/4 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/8 - (L2*mCM2*sin(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/8) + (conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2))/2 - (conj(dtheta1)*(mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + (L2*mCM2*cos(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 - (L2*mCM2*sin(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/4 - (L2*mCM2*sin(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/4))/2) - dtheta3*((conj(dtheta1)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))))/2 + dtheta1*((L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2) + (conj(dtheta2)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))))/2 + dtheta3*((L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2 - (L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + (conj(dtheta3)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + dtheta2*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2) + (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2 + (dxW*mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) - dtheta3*((conj(dtheta1)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))))/2 - (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2) + dtheta2*((conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2))/2 - (conj(dtheta1)*(mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + (L2*mCM2*cos(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 - (L2*mCM2*sin(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/4 - (L2*mCM2*sin(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/4))/2) - g*mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - (L2*g*mCM2*sin(theta1 + theta2))/2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                dtheta3*((conj(dtheta2)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) - L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + (conj(dtheta1)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) - L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2) - dtheta3*((conj(dtheta2)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) - L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + dtheta2*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + dtheta1*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + (conj(dtheta1)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) - L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2 + (dxW*mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + dtheta2*((conj(dtheta1)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))))/2 + (conj(dtheta2)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))))/2 + (conj(dtheta3)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2) - dtheta1*((L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2 + (dxW*mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + dtheta2*((conj(dtheta1)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))))/2 + dtheta1*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 - (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2) - (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2 - (dxW*mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + dtheta1*((conj(dtheta1)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))))/2 + (conj(dtheta2)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))))/2 + (conj(dtheta3)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) - L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2) + dxW*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta1))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta2))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta3))/2) - L3*g*mR*sin(theta1 + theta2 + theta3)];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
    tau = -K*(X(j,:) - X_ref)' + tau_ref_10;
    tau = [tau(1)/R; -tau(1); -tau(2); -tau(3)];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    u = 0*[dxW; dtheta1; dtheta2; dtheta3] + tau;
    qdd = (H\(u - C))';
    
    %Conditioning of matrix
    [eigVec, eigVal] = eig(H);
    eigVal_ar = diag(eigVal);
    cond = max(eigVal_ar)/min(eigVal_ar);
    cond_array(j) = cond;
    
    %Populating the ddq array
    ddX(j,1) = qdd(1);
    ddX(j,2) = qdd(2);
    ddX(j,3) = qdd(3);
    ddX(j,4) = qdd(4);
    
    %Single instance variables
    ddxW = ddX(j,1);
    ddtheta1 = ddX(j,2);
    ddtheta2 = ddX(j,3);
    ddtheta3 = ddX(j,4);
    
    Fext_z = - dtheta2*(dtheta1*(mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) + (L2*mCM2*cos(theta1 + theta2))/2) + dtheta2*(mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) + (L2*mCM2*cos(theta1 + theta2))/2) + L3*dtheta3*mR*cos(theta1 + theta2 + theta3)) - g*mR - ddtheta1*(mR*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) + mCM2*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)) + (L1*mCM1*sin(theta1))/2) - ddtheta2*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2) - dtheta1*(dtheta2*(mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) + (L2*mCM2*cos(theta1 + theta2))/2) + dtheta1*(mCM2*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)) + mR*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) + (L1*mCM1*cos(theta1))/2) + L3*dtheta3*mR*cos(theta1 + theta2 + theta3)) - L3*ddtheta3*mR*sin(theta1 + theta2 + theta3) - L3*dtheta3*mR*cos(theta1 + theta2 + theta3)*(dtheta1 + dtheta2 + dtheta3);
    %Fext_z = - dtheta2*(mR*(L3*cos(theta1 + theta2 + theta3)*(dtheta1 + dtheta2 + dtheta3) + L2*cos(theta1 + theta2)*(dtheta1 + dtheta2)) + (L2*m_leg2*cos(theta1 + theta2)*(dtheta1 + dtheta2))/2) - g*mR - ddtheta1*(mR*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) + m_leg2*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)) + (L1*m_leg1*sin(theta1))/2) - ddtheta2*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*m_leg2*sin(theta1 + theta2))/2) - dtheta1*(m_leg2*(L2*cos(theta1 + theta2)*(dtheta1 + dtheta2) + L1*dtheta1*cos(theta1)) + mR*(L3*cos(theta1 + theta2 + theta3)*(dtheta1 + dtheta2 + dtheta3) + L2*cos(theta1 + theta2)*(dtheta1 + dtheta2) + L1*dtheta1*cos(theta1)) + (L1*dtheta1*m_leg1*cos(theta1))/2) - L3*ddtheta3*mR*sin(theta1 + theta2 + theta3) - L3*dtheta3*mR*cos(theta1 + theta2 + theta3)*(dtheta1 + dtheta2 + dtheta3);
    Fext_array(j) = Fext_z;
    
    zR = L1*cos(theta1) + L2*cos(theta1+theta2) + L3*cos(theta1+theta2+theta3);
    zR_array(j) = zR;
    
end           

%%
limx = simTime;

figure(3);
plot(T,xW_array);
hold on 
plot(T,theta1_array);
hold on 
plot(T,theta2_array);
hold on 
plot(T,theta3_array);
xlim([0 limx]);
legend('xW', 'theta1', 'theta2', 'theta3');
xlabel('Time (sec)');
title('Positional Values');

figure(4);
plot(T,dxW_array);
hold on 
plot(T,dtheta1_array);
hold on 
plot(T,dtheta2_array);
hold on 
plot(T,dtheta3_array);
xlim([0 limx]);
legend('dxW', 'dtheta1', 'dtheta2', 'dtheta3');
xlabel('Time (sec)');
title('Velocity Values');

figure(5);
plot(T, Fext_array(1:length(xW_array)));
xlim([0 limx]);
legend('Fz External Calc');
xlabel('Time (sec)');
ylabel('Force_{z} (Nm)');
title('Calculating ground forces using Centroidal Momentum Matrix');

figure(6);
plot(T, zR_array(1:length(xW_array)));
xlim([0 limx]);
legend('zR Height');
xlabel('Time (sec)');
ylabel('Height (m)');
title('Height of Robot');

figure(7);
plot(T, cond_array(1:length(xW_array)));
xlim([0 limx]);
xlabel('Time (sec)');
ylabel('Conditioning number');
title('Conditioning of Mass Matrix starting at pi/18');
%ylim([0 2000]);

figure(8);
plot(T, ddX);
xlim([0 limx]);
xlabel('Time (sec)');
ylabel('Acceleration');
title('System Accelerations Graph');



    