function dX = SimpleSegway(t,X)

global K theta1_num theta2_num 

g = 9.81;
mW = .5;
m_motor = .2;
mK = .2*m_motor;
mH = 2*m_motor;
mCM1 = .1;
mCM2 = .1;
mR = 15;
L1 = 0.5; 
L2 = 0.5;
L3 = .1;
R = 0.05;
IW = mW*R^2; %
IK = mK*R^2;
IH = mH*R^2;
IR = mR*(2*L3)^2/12;


xW = X(1); 
theta1 = X(2); 
theta2 = X(3);
theta3 = X(4);
dxW = X(5); 
dtheta1 = X(6); 
dtheta2 = X(7);
dtheta3 = X(8);
t

%X_ref = [.1 theta1_num theta2_num 0 0 0 0 0]'; % Theta1 given. Found theta2 via COM calculations for stable point.
X_ref = [0 theta1_num theta2_num 0 0 0 0 0]'; % Theta1 given. Found theta2 via COM calculations for stable point.
%X_ref = [0 0 0 0 0 0 0 0]';

%tau_ref_0 = [0 0 0]';
tau_ref_10 = [0, -12.9039, -2.1446]';

H = [[                                                                                                                                                                                                                                                                                                                                                                                                        mCM1 + mCM2 + mR + mW + 13/(10000*R*conj(R)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (mCM2*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/2 + (mR*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (mCM2*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (mCM1*cos(conj(theta1))*conj(L1))/4 + (L1*mCM1*cos(theta1))/4,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 + (L2*mCM2*cos(theta1 + theta2))/4 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2))/4,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (L3*mR*cos(theta1 + theta2 + theta3))/2 + (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2]
[ (mCM2*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/2 + (mR*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (mCM2*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (mCM1*cos(conj(theta1))*conj(L1))/4 + (L1*mCM1*cos(theta1))/4,                                                                                                                                                                                                                                                                                                                                                                                                                            mCM2*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)) + mR*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + mCM2*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)) + mR*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (L1*mCM1*cos(conj(theta1))*conj(L1)*cos(theta1))/4 + (L1*mCM1*sin(conj(theta1))*conj(L1)*sin(theta1))/4 + 13/250, (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 + (mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L2*mCM2*sin(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/4 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/4 + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/4 + (L2*mCM2*cos(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/4 + 51/1000, (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + 1/20]
[                                                                                                                                                                         (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 + (L2*mCM2*cos(theta1 + theta2))/4 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2))/4, (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 + (mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L2*mCM2*sin(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/4 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/4 + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/4 + (L2*mCM2*cos(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/4 + 51/1000,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) + mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/4 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/4 + 51/1000,                                                                                             (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + 1/20]
[                                                                                                                                                                                                                                                                                                                                           (L3*mR*cos(theta1 + theta2 + theta3))/2 + (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + 1/20,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + 1/20,                                                                                                                                                                                                                                                                                                                                                                                                                                                               L3*mR*cos(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + L3*mR*sin(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + 1/20]];

[eigVec, eigVal] = eig(H);
eigVal_ar = diag(eigVal);
cond = max(eigVal_ar)/min(eigVal_ar);

C =[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - dtheta3*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta1))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta2))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta3))/2 + (L3*dtheta1*mR*sin(theta1 + theta2 + theta3))/2 + (L3*dtheta2*mR*sin(theta1 + theta2 + theta3))/2 + (L3*dtheta3*mR*sin(theta1 + theta2 + theta3))/2) - dtheta2*(dtheta1*((mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L2*mCM2*sin(theta1 + theta2))/4) + dtheta2*((mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L2*mCM2*sin(theta1 + theta2))/4) + (conj(dtheta1)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (conj(dtheta2)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta3))/2 + (L3*dtheta3*mR*sin(theta1 + theta2 + theta3))/2) - dtheta1*(dtheta1*((mR*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 + (mCM2*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/2 + (L1*mCM1*sin(theta1))/4) + dtheta2*((mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L2*mCM2*sin(theta1 + theta2))/4) + (conj(dtheta2)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (conj(dtheta1)*(mCM2*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2) + mR*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM1*sin(conj(theta1))*conj(L1))/2))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta3))/2 + (L3*dtheta3*mR*sin(theta1 + theta2 + theta3))/2)
                                                                                                                                                                                                                                                                                                                                               dxW*((conj(dtheta2)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (conj(dtheta1)*(mCM2*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2) + mR*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM1*sin(conj(theta1))*conj(L1))/2))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta3))/2) - dtheta1*(dxW*((mCM2*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (mR*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mCM1*sin(conj(theta1))*conj(L1))/4) + (conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) + mCM2*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)) + (L1*mCM1*sin(theta1))/2))/2) - dtheta3*((conj(dtheta1)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))))/2 + dtheta3*((L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2 - (L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + (conj(dtheta2)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))))/2 + dtheta2*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2) + dtheta1*((L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2) + (conj(dtheta3)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) - L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2 + (dxW*mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + dtheta2*(dtheta1*((mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 - (mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 - (mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L2*mCM2*cos(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/4 - (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/4 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/4 - (L2*mCM2*sin(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/4) + (conj(dtheta3)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) + mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))))/2 - dxW*((mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/4) + dtheta2*((mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 - (mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L2*mCM2*cos(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/4 - (L2*mCM2*sin(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/4 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/8 - (L2*mCM2*sin(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/8) + (conj(dtheta1)*(mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) - mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) + mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) - mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + (L2*mCM2*cos(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 - (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/2 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/2 - (L2*mCM2*sin(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/2))/2 - (conj(dtheta2)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) + mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/2 - (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/2 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/4 - (L2*mCM2*sin(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/4))/2 - (conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2))/2 + dtheta3*((L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2)) + (dtheta1*conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) + mCM2*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)) + (L1*mCM1*sin(theta1))/2))/2 + (dtheta2*conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2))/2 - g*mR*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) - g*mCM2*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)) - (L1*g*mCM1*sin(theta1))/2 + (L3*dtheta3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2
 dxW*((conj(dtheta1)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (conj(dtheta2)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta3))/2) - dtheta1*((conj(dtheta3)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) + mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))))/2 + (conj(dtheta1)*(mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) - mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) + mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) - mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + (L2*mCM2*cos(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 - (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/2 + (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/2 - (L2*mCM2*sin(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/2))/2 - (conj(dtheta2)*(mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) + mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/2 - (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/2 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/4 - (L2*mCM2*sin(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/4))/2 - (conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2))/2) - dtheta1*(dxW*((mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/4) + (conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2))/2) - dtheta2*(dxW*((mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2))/4) + dtheta1*((mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 + (mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 - (mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 + (mCM2*sin(conj(theta1) + conj(theta2))*conj(L2)*((L2*cos(theta1 + theta2))/2 + L1*cos(theta1)))/4 - (mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*((L2*sin(theta1 + theta2))/2 + L1*sin(theta1)))/4 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/8 - (L2*mCM2*sin(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/8) + (conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2))/2 - (conj(dtheta1)*(mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + (L2*mCM2*cos(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 - (L2*mCM2*sin(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/4 - (L2*mCM2*sin(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/4))/2) - dtheta3*((conj(dtheta1)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))))/2 + dtheta1*((L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2) + (conj(dtheta2)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))))/2 + dtheta3*((L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2 + (L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2 - (L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + (conj(dtheta3)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + dtheta2*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)))/2) + (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2 + (dxW*mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) - dtheta3*((conj(dtheta1)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))))/2 - (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2) + dtheta2*((conj(dxW)*(mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + (L2*mCM2*sin(theta1 + theta2))/2))/2 - (conj(dtheta1)*(mR*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3))*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + mR*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2))*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - mR*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3))*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + (L2*mCM2*cos(theta1 + theta2)*(sin(conj(theta1))*conj(L1) + (sin(conj(theta1) + conj(theta2))*conj(L2))/2))/2 - (L2*mCM2*sin(theta1 + theta2)*(cos(conj(theta1))*conj(L1) + (cos(conj(theta1) + conj(theta2))*conj(L2))/2))/2 + (L2*mCM2*cos(conj(theta1) + conj(theta2))*conj(L2)*sin(theta1 + theta2))/4 - (L2*mCM2*sin(conj(theta1) + conj(theta2))*cos(theta1 + theta2)*conj(L2))/4))/2) - g*mR*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - (L2*g*mCM2*sin(theta1 + theta2))/2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            dtheta3*((conj(dtheta2)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) - L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + (conj(dtheta1)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) - L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2) - dtheta3*((conj(dtheta2)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) - L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + dtheta2*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + dtheta1*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2 - (L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + (conj(dtheta1)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) - L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2 + (dxW*mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + dtheta2*((conj(dtheta1)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))))/2 + (conj(dtheta2)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) + L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))))/2 + (conj(dtheta3)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)) - L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2) - dtheta1*((L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2 + (dxW*mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + dtheta2*((conj(dtheta1)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2))))/2 + dtheta1*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L3*cos(theta1 + theta2 + theta3)))/2 - (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L3*sin(theta1 + theta2 + theta3)))/2 - (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)))/2 + (mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)))/2) - (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2 - (dxW*mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3))/2) + dtheta1*((conj(dtheta1)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1))*conj(L1) + cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) + mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1))*conj(L1) + sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))))/2 + (conj(dtheta2)*(L3*mR*sin(theta1 + theta2 + theta3)*(cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + cos(conj(theta1) + conj(theta2))*conj(L2)) - L3*mR*cos(theta1 + theta2 + theta3)*(sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + sin(conj(theta1) + conj(theta2))*conj(L2)) + mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3))))/2 + (conj(dtheta3)*(mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*cos(theta1 + theta2) + L1*cos(theta1) + L3*cos(theta1 + theta2 + theta3)) - mR*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*(L2*sin(theta1 + theta2) + L1*sin(theta1) + L3*sin(theta1 + theta2 + theta3)) - L3*mR*cos(theta1 + theta2 + theta3)*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3) + L3*mR*sin(theta1 + theta2 + theta3)*cos(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)))/2 + (L3*mR*sin(theta1 + theta2 + theta3)*conj(dxW))/2) + dxW*((mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta1))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta2))/2 + (mR*sin(conj(theta1) + conj(theta2) + conj(theta3))*conj(L3)*conj(dtheta3))/2) - L3*g*mR*sin(theta1 + theta2 + theta3)];

X = X - X_ref;
tau = -K*X;
tau = tau + tau_ref_10;

tau = [tau(1)/R; -tau(1); -tau(2); -tau(3)];
u = 0*[dxW; dtheta1; dtheta2; dtheta3] + tau;
ddq = H\(u - C);

 
dX = [[dxW; dtheta1; dtheta2; dtheta3]; [ddq(1); ddq(2); ddq(3); ddq(4)]];

end